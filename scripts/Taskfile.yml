# https://taskfile.dev

version: '3'

dotenv: ['.env']

vars:
  GENERATOR_POLICY: /mapping/generator-policy.xml

tasks:

  download-iiif-manifests:
    cmds:
      - python /scripts/cache-iiif-manifests.py {{.IIIF_MANIFESTS_FROM}} {{.IIIF_MANIFESTS_TO}}

  preprocessing-zbz-to-xml:
    cmds:
      - python /scripts/json-to-xml.py

  mapping-zbz:
    vars:
      INPUT_FOLDER: /data/xml/zbz
      OUTPUT_FOLDER: /data/ttl/main
      MAPPING_FILE: /mapping/mappings-zbz.x3ml
      BATCHSIZE: 20
    cmds:
      - bash /scripts/performMapping.sh -i {{.INPUT_FOLDER}} -o {{.OUTPUT_FOLDER}} -m {{.MAPPING_FILE}} -g {{.GENERATOR_POLICY}} -b {{.BATCHSIZE}}

  mapping-nb:
    vars:
      INPUT_FOLDER: /data/xml/nb
      OUTPUT_FOLDER: /data/ttl/main
      MAPPING_FILE: /mapping/mappings-nb.x3ml
      BATCHSIZE: 20
    cmds:
      - bash /scripts/performMapping.sh -i {{.INPUT_FOLDER}} -o {{.OUTPUT_FOLDER}} -m {{.MAPPING_FILE}} -g {{.GENERATOR_POLICY}} -b {{.BATCHSIZE}}

  post-retrieve-gnd:
    cmds:
      - python /scripts/extract-gnd-data.py

  post-retrieve-wikidata:
    cmds:
      - python /scripts/extract-wd-data.py

  ingest-data:
    vars:
      MAIN_DATA_FOLDER: /data/ttl/main
      ADDITIONAL_DATA_FOLDER: /data/ttl/additional
      ENDPOINT: http://blazegraph:8080/blazegraph/sparql

    cmds:
      - |
        echo "Ingest main data"
        numfiles=$(ls -l {{.MAIN_DATA_FOLDER}}/*.ttl | wc -l)
        count=1
        for f in $(ls -1 {{.MAIN_DATA_FOLDER}}/*.ttl); do
          echo "Ingesting file $count of $numfiles ($f)"
          curl --silent -X POST {{.ENDPOINT}} --data-urlencode "update=DELETE { ?s ?p ?o } WHERE { GRAPH <file:/$f> { ?s ?p ?o } }" > /dev/null
          curl --silent -X POST --data-binary "uri=file://$f" {{.ENDPOINT}} > /dev/null
          count=$((count+1)) 
        done

        echo "Ingest additional data"
        numfiles=$(ls -l {{.ADDITIONAL_DATA_FOLDER}}/*.ttl | wc -l)
        count=1
        for f in $(ls -1 {{.ADDITIONAL_DATA_FOLDER}}/*.ttl); do
          echo "Ingesting record $count of $numfiles ($f)"
          curl --silent -X POST {{.ENDPOINT}} --data-urlencode "update=DELETE { ?s ?p ?o } WHERE { GRAPH <file:/$f> { ?s ?p ?o } }" > /dev/null
          curl --silent -X POST --data-binary "uri=file://$f" {{.ENDPOINT}} > /dev/null
          count=$((count+1)) 
        done

